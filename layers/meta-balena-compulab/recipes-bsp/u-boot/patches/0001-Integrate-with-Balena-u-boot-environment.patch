From a28d12a58c95f33ebc1065427da19ee22aabf0c8 Mon Sep 17 00:00:00 2001
From: Vicentiu Galanopulo <vicentiu@balena.io>
Date: Wed, 14 Aug 2019 14:39:04 +0200
Subject: [PATCH] Integrate with Balena u-boot environment

Integrated u-boot with Balena environment
and added unzipping of the kernel image.

Upstream-Status: Inappropriate [configuration]
Signed-off-by: Vicentiu Galanopulo  <vicentiu@balena.io>
---
 configs/cl-som-imx8_defconfig |  4 ++++
 include/configs/cl-som-imx8.h | 13 +++++++++----
 2 files changed, 13 insertions(+), 4 deletions(-)

diff --git a/configs/cl-som-imx8_defconfig b/configs/cl-som-imx8_defconfig
index 379dfe798b..da4e411e99 100644
--- a/configs/cl-som-imx8_defconfig
+++ b/configs/cl-som-imx8_defconfig
@@ -44,6 +44,10 @@ CONFIG_DM_REGULATOR_PFUZE100=y
 CONFIG_DM_REGULATOR_FIXED=y
 CONFIG_DM_REGULATOR_GPIO=y
 CONFIG_DM_THERMAL=y
+CONFIG_CMD_UNZIP=y
+CONFIG_CMD_IMPORTENV=y
+CONFIG_PARTITION_UUIDS=y
+CONFIG_CMD_PART=y
 CONFIG_USB=y
 CONFIG_DM_USB=y
 CONFIG_USB_XHCI_HCD=y
diff --git a/include/configs/cl-som-imx8.h b/include/configs/cl-som-imx8.h
index b991ef9fcd..9b036d9faf 100644
--- a/include/configs/cl-som-imx8.h
+++ b/include/configs/cl-som-imx8.h
@@ -114,7 +114,8 @@
 #define CONFIG_EXTRA_ENV_SETTINGS		\
 	CONFIG_MFG_ENV_SETTINGS \
 	"script=boot.scr\0" \
-	"image=Image\0" \
+	"image=Image.gz\0" \
+	"zip_addr=0x41480000\0" \
 	"console=ttymxc2,115200 earlycon=ec_imx6q,0x30880000,115200\0" \
 	"fdt_addr=0x43000000\0"			\
 	"fdt_high=0xffffffffffffffff\0"		\
@@ -125,11 +126,11 @@
 	"mmcdev="__stringify(CONFIG_SYS_MMC_ENV_DEV)"\0" \
 	"mmcpart=" __stringify(CONFIG_SYS_MMC_IMG_LOAD_PART) "\0" \
 	"mmcautodetect=yes\0" \
-	"mmcargs=setenv bootargs console=${console} root=/dev/mmcblk${mmcdev}p2 rootwait rw\0 " \
+	"mmcargs=setenv bootargs console=${console} ${resin_kernel_root} rootwait rw ${os_cmdline} \0" \
 	"loadbootscript=load mmc ${mmcdev}:${mmcpart} ${loadaddr} ${script};\0" \
 	"bootscript=echo Running bootscript from mmc ...; " \
 		"source\0" \
-	"loadimage=load mmc ${mmcdev}:${mmcpart} ${loadaddr} ${image}\0" \
+	"loadimage=load mmc ${mmcdev}:${mmcpart} ${zip_addr} ${image}; unzip ${zip_addr} ${loadaddr};\0" \
 	"loadfdt=load mmc ${mmcdev}:${mmcpart} ${fdt_addr} ${fdt_file}\0" \
 	"mmcboot=echo Booting from mmc ...; " \
 		"run mmcargs; " \
@@ -165,6 +166,10 @@
 		"fi;\0"
 
 #define CONFIG_BOOTCOMMAND \
+	    "setenv resin_kernel_load_addr ${loadaddr};" \
+	    "run resin_set_kernel_root; run set_os_cmdline; " \
+	    "setenv mmcdev ${resin_dev_index};" \
+	    "setenv mmcbootpart ${resin_boot_part};" \
 	   "mmc dev ${mmcdev}; if mmc rescan; then " \
 		   "if run loadbootscript; then " \
 			   "run bootscript; " \
@@ -190,7 +195,7 @@
 
 #define CONFIG_ENV_OVERWRITE
 #define CONFIG_ENV_OFFSET               (64 * SZ_64K)
-#define CONFIG_ENV_SIZE			0x1000
+#define CONFIG_ENV_SIZE			0x2000
 #define CONFIG_SYS_MMC_ENV_DEV		0   /* USDHC1/eMMC */
 #define CONFIG_MMCROOT			"/dev/mmcblk0p2"  /* USDHC1 */
 
-- 
2.17.1

